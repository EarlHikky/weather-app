<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather App</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <h1 class="mt-5">Weather App</h1>
  <form method="POST" class="mt-3">
    {% csrf_token %}
    <div class="form-group">
      <label for="city">Enter city name:</label>
      <input type="text" class="form-control" id="city" name="city" value="{{ last_city }}" required>
    </div>
    <button type="submit" class="btn btn-primary">Get Weather</button>
  </form>
  {% if weather_data_times %}
    <div class="mt-5">
      <h2>Weather in {{ city }} on {{ current_date }}</h2>
      <p>Now: {{ current_temperature }}°C</p>
    </div>
    <canvas id="weatherChart" width="800" height="400"></canvas>
  {% endif %}
</div>

<script>
  $(document).ready(function() {
      $("#city").autocomplete({
          source: function(request, response) {
              $.ajax({
                  url: "{% url 'autocomplete_city' %}",
                  dataType: "json",
                  data: {
                      term: request.term
                  },
                  success: function(data) {
                      response(data);
                  }
              });
          },
          minLength: 2,
      });

      // Извлечение данных для графика
      var labels = [
          {% for time in weather_data_times %}
              "{{ time }}",
          {% endfor %}
      ].map(time => new Date(time).toLocaleTimeString('en-US', { hour: "2-digit", minute: "2-digit", hour12: false }));

      var temperatures = [
          {% for temp in weather_data_temperatures %}
              {{ temp|floatformat:"0" }},
          {% endfor %}
      ];

      // Подготовка данных для графика
      var data = {
          labels: labels,
          datasets: [{
              label: 'Temperature',
              backgroundColor: 'rgb(54, 162, 235)',
              borderColor: 'rgb(54, 162, 235)',
              data: temperatures,
              fill: false,
          }]
      };

      // Создание графика
      var ctx = document.getElementById('weatherChart').getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'line',
          data: data,
          options: {
              responsive: true,
              plugins: {
                  title: {
                      display: true,
                      text: 'Hourly Temperature Forecast'
                  },
                  legend: {
                      display: false
                  }
              },
              scales: {
                  x: {
                      display: true,
                      title: {
                          display: true,
                          text: 'Time'
                      }
                  },
                  y: {
                      display: true,
                      title: {
                          display: true,
                          text: 'Temperature (°C)'
                      }
                  }
              }
          }
      });
  });
</script>
</body>
</html>
